<!--Modal Attributes: isWareSelected(selectedWareNo, items), Navbar -->

<!--Headers-->
<header th:insert="fragments/header.html"> </header>
<!--Navbars-->
<span th:insert="fragments/navbar.html"> </span>

<!--Content-->

<div class="container-fluid mx-auto px-5 py-4">
    <h1>Dashboard</h1>

    <div class="mt-4">
        <a href="/warehouse/create" class="btn btn-primary mx-2"
           data-toggle="tooltip" data-placement="top" title="Create Warehouse">Add Warehouse</a>
        <a href="/items/create" class="btn btn-primary mx-2"
           data-toggle="tooltip" data-placement="top" title="Create Item">Add Item</a>
        <a href="/items/inventory/create"  class="btn btn-primary mx-2"
           data-toggle="tooltip" data-placement="top" title="Create Inventory">Add Inventory</a>

        <span th:if="${isWareSelected}">
            <a class="btn btn-primary mx-2" th:href="@{/warehouse/receive/{id}(id=${selectedWare.wareNo})}">
                Receive Shipment
            </a>
        </span>

        <span th:if="${isWareSelected}">
            <a class="btn btn-primary mx-2" th:href="@{/warehouse/shipment/{id}(id=${selectedWare.wareNo})}">
                Send Shipment
            </a>
        </span>
        <!--If warehouse not selected show option to select warehouse-->
        <span class="dropdown" th:unless="${isWareSelected}">
            <button class="btn btn-primary mx-2 dropdown-toggle" type="button" id="shipmentWarehouseSelect"
                  data-bs-toggle="dropdown" aria-expanded="false">
                Send Shipment
            </button>
            <ul class="dropdown-menu" aria-labelledby="shipmentWarehouseSelect">
                <li class="fst-italic dropdown-item disabled">From</li>
                <li><hr class="dropdown-divider"></li>
                <li th:each="ware: ${wares}">
                    <a class="dropdown-item" href="#" th:text="${ware.name}"
                       th:href="@{/warehouse/shipment/{id}(id=${ware.wareNo})}">
                        Warehouse
                    </a>
                </li>

                <li th:if="${#lists.isEmpty(wares)}">
                    <a href="/warehouse/create" type="button" class="btn btn-primary mx-2"
                       data-toggle="tooltip" data-placement="top" title="Create Warehouse">Add Warehouse</a>
                </li>
            </ul>
        </span>
    </div>

    <!--Warehouse Name-->
    <H2 class="mt-5 d-flex flex-row mb-3" style="align-items: center;">
        <div>
            Items: <span th:text="${selectedWareName}">All Items</span>
        </div>

        <!--Edit warehouse if selected-->
        <div th:if="${isWareSelected}" class="ms-3">
            <a th:href="@{/warehouse/edit/{id}(id=${selectedWare.wareNo})}">
                <i class="fa fa-edit text-info"></i></button>
            </a>
        </div>

        <!--Download data on page-->
        <div class="dropdown ms-3">
            <a class="text-dark" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false"
               style="text-decoration: none;">
                <i class="fa-solid fa-arrow-down"></i>
            </a>

            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                <span style="display: none" th:if="${isWareSelected}" th:text="${selectedWare.wareNo}" id="csvDownloadWareNo"></span>
                <span style="display: none" th:unless="${isWareSelected}"  id="csvDownloadWareNo">0</span>
                <li><button class="dropdown-item" onclick="downloadWarehouseData('csv')">Download CSV</button></li>
            </ul>
        </div>
    </H2>

    <!--Warehouse info-->
    <div th:if="${isWareSelected}" class="mb-4">
        <div>
            <span th:text="${selectedWare.getDisplayStr()}"></span>

            <!--Display weather-->
            <span>, Weather:&nbsp;</span>
            <span id="wareWeather">
                Loading...
            </span>
            <span style="display: none" id="wareLat" th:text="${selectedWare.lat}"></span>
            <span style="display: none" id="wareLng" th:text="${selectedWare.lng}"></span>
            <span style="display: none" id="weatherApiKey" th:text="${weatherApiKey}"></span>
            <script>
            </script>
        </div>


    </div>

    <!--Items-->
    <div class="accordion" id="accordionItems">

        <!--Accordion items-->
        <div class="accordion-item" th:each="item : ${items}">
            <!--Item title-->
            <h2 class="accordion-header" th:id="@{|itemHeadingId-${itemStat.count}|}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" th:attr="data-bs-target=@{|#itemBlockId-${itemStat.count}|},aria-controls=@{|itemBlockId-${itemStat.count}|}" aria-expanded="false">
                    <span th:text="${item.getDisplayStr()}"></span>
                </button>
            </h2>
            <!--todo: add pallet summary-->
            <!--Pallet info, item add-ons-->
            <div th:id="@{|itemBlockId-${itemStat.count}|}" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionItems">
                <div class="accordion-body ms-4">
                    <!--Buttons for item edit-->
                    <ul class="list-inline mb-3">
                        <!--Add inventory-->
                        <li class="list-inline-item">
                            <span th:if="${isWareSelected}">
                                <a th:href="@{/items/inventory/create(itemNo=${item.itemNo},wareNo=${selectedWareNo})}">
                                    <i class="fa-solid fa-file-circle-plus text-success h4"></i>
                                </a>
                            </span>
                            <span th:unless="${isWareSelected}">
                                <a th:href="@{/items/inventory/create(itemNo=${item.itemNo})}">
                                    <i class="fa-solid fa-file-circle-plus text-success h4"></i>
                                </a>
                            </span>
                        </li>

                        <!--Edit item-->
                        <li class="list-inline-item">
                            <span th:if="${isWareSelected}">
                                <a th:href="@{/items/edit/{itemNo}(itemNo=${item.itemNo},wareNo=${selectedWareNo})}">
                                    <i class="fa fa-edit text-info h4"></i></button>
                                </a>
                            </span>
                            <span th:unless="${isWareSelected}">
                                <a th:href="@{/items/edit/{itemNo}(itemNo=${item.itemNo})}">
                                    <i class="fa fa-edit text-info h4"></i></button>
                                </a>
                            </span>
                        </li>

                        <!--Delete Item-->
                        <li class="list-inline-item">
                            <span th:if="${isWareSelected}">
                                <a th:href="@{/items/delete/{itemNo}(itemNo=${item.itemNo},wareNo=${selectedWareNo})}">
                                    <i class="fa-solid fa-trash text-danger h4"></i>
                                </a>
                            </span>
                            <span th:unless="${isWareSelected}">
                                <a th:href="@{/items/delete/{itemNo}(itemNo=${item.itemNo})}">
                                    <i class="fa-solid fa-trash text-danger h4"></i>
                                </a>
                            </span>
                        </li>
                    </ul>

                    <!--Pallet information-->
                    <div th:each="pallet : ${item.pallets}" th:text="${pallet.getDisplayStr()}"></div>
                </div>
            </div>
        </div>

    </div>

    <script th:if="${isWareSelected}">
        async function loadWeather() {
            // get the elements with the required data
            let wareLat = document.getElementById("wareLat").innerText;
            let wareLng = document.getElementById("wareLng").innerText;
            let weatherApiKey = document.getElementById("weatherApiKey").innerText;

            // make the request
            let weatherApi = `http://api.weatherapi.com/v1/current.json?key=${weatherApiKey}`
                    + `&q=${wareLat},${wareLng}&aqi=no`;
            let weatherResp = await fetch(weatherApi);
            weatherResp = await weatherResp.json();

            // fill the data on UI
            let currentText = weatherResp.current.condition.text;
            let currentIcon = weatherResp.current.condition.icon;
            let wareWeather = document.getElementById("wareWeather");
            let imageEl = document.createElement("img");
            imageEl.src = `https:${currentIcon}`;
            wareWeather.innerText = currentText
            wareWeather.appendChild(imageEl);
        }

        window.addEventListener('load', loadWeather);
    </script>

    <script>
        let allowedDataTypes = new Set();
        allowedDataTypes.add("csv");

        /**
         * Downloads the warehouse data in the given format
         * @param dataType the data type to request
         */
        async function downloadWarehouseData(dataType) {
            if (!allowedDataTypes.has(dataType)) {
                console.log(`Err: ${dataType} isn't supported`);
                return;
            }
            let respData = await getDownloadData(dataType);
            addDownloadData(respData)
        };

        /**
         * Gets the data in the required format
         */
        async function getDownloadData(dataType) {
            let wareNo = parseInt(document.getElementById("csvDownloadWareNo").innerText);
            let baseUrl = window.location.origin;
            let getDataUrl = `${baseUrl}/api/v1/warehouses/data/${dataType}/${wareNo}`;
            let respData = await fetch(getDataUrl);
            respData = await respData.json()
            return respData;
        }

        /**
         * Downloads the loaded file
         */
        function addDownloadData(respData) {
            let downloadElement = document.createElement('a');
            downloadElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(respData.data);
            downloadElement.target = '_blank';
            //provide the name for the CSV file to be downloaded
            downloadElement.download = respData.filename;
            document.body.appendChild(downloadElement);
            downloadElement.click();
        }
    </script>

</div>

<!--Footer-->
<span th:insert="fragments/footer.html"> </span>